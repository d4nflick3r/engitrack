      - name: Add Engineer Name field + include in CSV filename (robust)
        run: |
          set -e
          cd "${{ steps.findroot.outputs.root }}"

          cat <<'JS' > engineer_name_patch.cjs
const fs = require("fs");

const file = "client/src/pages/Home.tsx";
if (!fs.existsSync(file)) {
  console.log("Home.tsx not found, skipping.");
  process.exit(0);
}

let s = fs.readFileSync(file, "utf8");

// Repair broken injection if present
s = s.replace(/const\s+fileName\s*=\s*;\s*/g, "");

// Ensure useState is imported
const reactImport = /import\s+[^;]*\{([^}]*)\}[^;]*from\s+["']react["']/m;
const match = s.match(reactImport);
if (match && !match[1].includes("useState")) {
  s = s.replace(
    reactImport,
    (full, inside) => full.replace(inside, inside + ", useState")
  );
}

// Inject state block once
if (!s.includes("__ENGINEER_NAME_FIELD__")) {
  const block = `
  /* __ENGINEER_NAME_FIELD__ */
  const [engineerName, setEngineerName] = useState("");
  const engineerSlug = (engineerName || "engineer")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
  const fileName = \`timesheet-\${engineerSlug}-\${new Date().toISOString().slice(0,10)}.csv\`;
`;

  s = s.replace(
    /(export\s+default\s+function\s+Home\s*\([^)]*\)\s*\{)/,
    `$1${block}`
  );
}

// Inject UI once
if (!s.includes("__ENGINEER_NAME_INPUT__")) {
  const ui = `
        {/* __ENGINEER_NAME_INPUT__ */}
        <div className="w-full max-w-3xl mx-auto px-4 mt-2">
          <label className="block text-sm font-medium mb-1">Engineer Name</label>
          <input
            value={engineerName}
            onChange={(e)=>setEngineerName(e.target.value)}
            placeholder="Type your name"
            className="w-full rounded-md border px-3 py-2 text-base"
          />
        </div>
`;

  if (s.includes("</h1>")) {
    s = s.replace("</h1>", "</h1>" + ui);
  }
}

// Replace literal csv path with fileName
s = s.replace(
  /(Filesystem\.writeFile\s*\(\s*\{[\s\S]*?\bpath\s*:\s*)(["'][^"']+\.csv["'])/m,
  `$1fileName`
);

fs.writeFileSync(file, s, "utf8");
console.log("Engineer name patch applied successfully.");
JS

          node engineer_name_patch.cjs
